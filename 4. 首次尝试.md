## 4. 首次尝试

本章将延时pybind11的基本特性。在开始前，请确保已配置了编译pybind11测试用例的开发环境。

### 4.1 编译测试用例

#### Linux/macOS

在Linux上，你需要安装python-dev或python3-dev包和cmake。在macOS上，系统已经自带了所需的python版本，但cmake还是需要安装。

在安装好依赖项之后，运行下面的脚本：
```sh
mkdir build
cd build
cmake ..
make check -j 4
```

脚本的最后一行将编译并运行测试用例。

#### Windows

在Windows上，需要支持C++11的Visual Studio版本（15及其以上）。

> Note：在Visual Studio 2017(MSVC 14.1)上使用C++17时，pybind11需要添加标识`/permissive-`来让编译器强制标准一致。在Visual Studio 2019上，同样建议添加，虽然不是强制要求。

使用以下命令编译和运行测试用例：
```sh
mkdir build
cd build
cmake ..
cmake --build . --config Release --target check
```

以上命令将在命令行创建Visual Studio工程，编译并运行项目。
> Note：如果测试失败了，请确保Python程序和测试用例是由同一类型处理器（如i386或x86_64）。你可以指定x86_64为目标架构来生成vs工程，命令像这样`cmake -A x64 ..`。

### 4.2 头文件和命名空间约定

为简洁起见，所有代码示例都假定存在以下两行：
```c++
#include <pybind11/pybind11.h>
namespace py = pybind11;
```

某些功能可能需要其他头文件，但会根据需要指定。

### 4.3 为简单函数创建绑定

我们将从绑定一个简单的加法函数来延时pybind11的使用。
```c++
int add(int i, int j) {
    return i + j;
}
```

简单起见，我们将加法函数和绑定代码都放到`example.cpp`文件中，内容如下：
```c++
#include <pybind11/pybind11.h>

int add(int i, int j) {
    return i + j;
}

PYBIND11_MODULE(example, m) {
    m.doc() = "pybind11 example plugin"; // optional module docstring
    m.def("add", &add, "A function which adds two numbers");
}
```

`PYBIND11_MODULE`会创建一个函数，它在Python中使用`import`语句时被调用。宏的第一个参数是模块名（example），不使用引号包住；第二个参数是类型为`py::module_`的变量（m），它是创建绑定的主要接口。`module_::def()`方法，则会生成add函数的Python绑定代码。

> Note：我们只需要少量的代码就可以将函数暴露给Python，所有跟函数入参和返回值相关的细节都由模板元编程自动推断。这种方式和语法是借用Boost.Python的，尽管底层实现是完全不同的。

pybind11是一个head-only库，因此它不需要链接任何库，和魔法般的中间转换步骤。在Linux上，上面的例子可以使用下面的命令进行编译：
```sh
c++ -O3 -Wall -shared -std=c++11 -fPIC $(python3 -m pybind11 --includes) example.cpp -o example$(python3-config --extension-suffix)
```

> Note：如果你使用子模块的方式包含pybind11代码，这里我们需要使用`$(python3-config --includes) -Iextern/pybind11/include`代替`$(python3 -m pybind11 --includes)`。原因在后续章节会解释。

如果需要更多有关于Linux和MacOS上所需编译标志的详细信息，请参阅手动构建章节。有关完整的跨平台编译说明，请参阅构建系统章节。

编译上面的C++代码后，我们会得到一个二进制模块文件，我们可以直接使用`import`导入到Python中。假设编译好的模块位于当前目录下，后面的Python交互示例代码如下：
```python
>>> import example
>>> example.add(1, 2)
3L
>>> 
```

### 4.4 关键字参数

下面我们将对上面的C++代码做一点改造，就可以通知Python有关参数的名称（如本例中的“i”和“j”）。
```c++
m.def("add", &add, "A function which adds two numbers",
      py::arg("i"), py::arg("j"));
```

arg是可用于将元数据传递到module::def()的几个特殊标记类之一。使用这个修改后的绑定代码，我们可以使用关键字参数来调用函数，这更具可读性，特别是带有许多参数的函数。